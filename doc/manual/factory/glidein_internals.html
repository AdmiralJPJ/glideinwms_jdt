<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
	<TITLE>Glidein Internals</TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 2.4  (Linux)">
	<META NAME="CREATED" CONTENT="0;0">
	<META NAME="CHANGEDBY" CONTENT="Igor Sfiligoi">
	<META NAME="CHANGED" CONTENT="20081008;16174900">
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<H1>Glidein Internals</H1>
<P>This document describes the internals of a glidein.</P>
<H2>Index</H2>
<UL>
	<LI><P><A HREF="#overview">Overview of the glidein mechanism</A></P>
	<LI><P><A HREF="#flow">Program flow</A></P>
	<UL>
		<LI><P><A HREF="#flow_work">Find and perform work</A></P>
		<LI><P><A HREF="#flow_advertise">Advertise myself</A></P>
		<LI><P><A HREF="#flow_stats">Write statistics</A></P>
	</UL>
	<LI><P><A HREF="#source">Source code distribution</A></P>
	<LI><P><A HREF="#config">Configuration files</A></P>
	<UL>
		<LI><P><A HREF="#config_global">Shared configuration files</A></P>
		<LI><P><A HREF="#config_local">Entry-specific configuration files</A></P>
	</UL>
</UL>
<H2><A NAME="overview"></A>Overview of the glidein mechanism</H2>
<P>A glidein is, simply put, a properly configured <A HREF="http://www.cs.wisc.edu/condor/manual/v7.0/3_1Introduction.html#SECTION00412000000000000000">Condor
Startd</A> submitted as a Grid job. Once a glidein starts on a worker
node, it will join a specified Condor pool, making the obtained
Grid-batch slot a slot in the Condor pool. At this point, a regular
Condor job can start there as if was a dedicated resource. <BR>See
the picture below for a schematic overview.<BR><IMG SRC="../glideins.png"><BR>Condor
glideins are a convenient way to expand a Condor pool. Apart from the
task of submitting new glideins as needed, everything else stays the
same as in a dedicated pool.</P>
<P>In glideinWMS, the <A HREF="index.html">Glidein Factory</A> is the
one that submits the glideins to the Grid resources, as shown in the
picture below.</P>
<P><IMG SRC="overview.png"><BR CLEAR=LEFT>This
document describes how a glidein configures and starts the <A HREF="http://www.cs.wisc.edu/condor/manual/v7.0/3_1Introduction.html#SECTION00412000000000000000">Condor
Startd</A>.</P>
<P>The glidein a factory sends is thus just a wrapper. However, it
must perform several tasks, including:</P>
<UL>
	<LI><P>check that the working environment on the worker node is
	reasonable (else user jobs will fail) </P>
	<LI><P>obtain the Condor binaries </P>
	<LI><P>configure Condor </P>
	<LI><P>prepare the environment for Condor and the user jobs </P>
	<LI><P>start Condor 
	</P>
</UL>
<P>Given the complexity of the task, and for the sake of flexibility,
it makes sense to split the script in several pieces. So the glidein
job is composed of several pieces, including a startup script, helper
scripts, the Condor binaries, and a base configuration file. 
</P>
<P>However, having a Grid job with data files can represent a
challenge; each Grid flavor treats data in a different way. To make
the system as general as possible, the glideins rely on HTTP for data
distribution. However, since the HTTP protocol is not a secure one,
the glidein implements its own security on top of it. 
</P>
<P>The picture below for an overview.<BR><IMG SRC="glidein_script.png"><BR><BR>The
security is implemented using SHA1 signatures. The signature checking
is implemented in two steps:</P>
<OL>
	<LI>The signatures of all the files to be transfered are saved in a
	signature file and stored on the Web server. The signature of the
	signature file is then passed as one of the parameters of the
	glidein job. 
	<LI><P>The glidein startup script loads the signature file from the
	Web server and verifies its signature. All other downloads,
	including the file containing the list of other files, is checked
	against the values in the signature file. See the pseudo-code below.</P>
	<PRE>wget http://head.fnal.gov/glidein_g1/signature.sha1
sha1sum <I>known_sha1</I> signature.sha1
if $?!=0 then
 exit 1
fi
grep files_name signature.sha1 &gt; file.sha1
wget http://head.fnal.gov/glidein_g1/files_anme
sha1sum -c file.sha1
if $?!=0 then
 exit 2
fi</PRE>
</OL>
<P>Assuming that the glidein arguments cannot be tampered with, all
the files are tamper evident.</P>
<P>If a file is marked as executable, it will be run. This allows to
customize the glidein logic at will.<BR>However, if not all files
need to be executable; plain files, like configuration files, and
tarballs are also supported.</P>
<H2><A NAME="flow"></A>Program flow</H2>
<P>As said in the overview, a glidein is basically a wrapper that
downloads other files, executing some of them. At the high level,
three types of files are handled:</P>
<UL>
	<LI><P>Signature files</P>
	<LI><P>Files containing lists of other files</P>
	<LI><P>Helper files; these can be either simple files, tarballs or
	executables.</P>
</UL>
<P>The files are also split between general, or factory wide, and
entry-specific ones. Since order can be important, especially when
executables are involved, the glidein allows for global helper files
to be loaded before and/or after the entry-specific ones.<BR>One
executable is special; this is the helper script that starts the
<A HREF="http://www.cs.wisc.edu/condor/manual/v7.0/3_1Introduction.html#SECTION00412000000000000000">Condor
Startd</A>. This one must be the last to be run, so it is handled in
a special way.</P>
<P>See the picture below for an overview.</P>
<P><IMG SRC="flow_glidein_main.png"><BR CLEAR=LEFT>To
be finished...</P>
<P><BR><BR>
</P>
<TABLE WIDTH=100% BORDER=0 CELLPADDING=2 CELLSPACING=2>
	<TR VALIGN=TOP>
		<TD>
			<H2 ALIGN=LEFT>Repository</H2>
			<H3 ALIGN=LEFT>CVSROOT</H3>
			<P ALIGN=LEFT>cvsuser@cdcvs.fnal.gov:/cvs/cd</P>
			<H2 ALIGN=LEFT>Package(s)</H2>
			<P ALIGN=LEFT>glideinWMS/creation</TD>
		<TD>
			<H2 ALIGN=LEFT>Author(s)</H2>
			<P ALIGN=LEFT>Since Aug. 14th 2006 - Igor Sfiligoi (Fermilab
			Computing Division)</TD>
	</TR>
</TABLE>
<P><BR><BR>
</P>
</BODY>
</HTML>
