<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
	<TITLE>Glidein Internals</TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 3.0  (Linux)">
	<META NAME="CREATED" CONTENT="0;0">
	<META NAME="CHANGED" CONTENT="20081014;14370600">
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<H1>Glidein Internals</H1>
<P>This document describes the internals of a glidein.</P>
<H2>Index</H2>
<UL>
	<LI><P><A HREF="#overview">Overview of the glidein mechanism</A></P>
	<LI><P><A HREF="#flow">Program flow</A></P>
	<UL>
		<LI><P><A HREF="#flow_sign">Get signatures and file info</A></P>
		<LI><P><A HREF="#flow_file">Download and process a file</A></P>
		<LI><P><A HREF="#flow_condor">Configure and start Condor</A></P>
	</UL>
	<LI><P><A HREF="#source">Source code distribution</A></P>
	<LI><P><A HREF="#config">Configuration files</A></P>
	<UL>
		<LI><P><A HREF="#config_global">Shared configuration files</A></P>
		<LI><P><A HREF="#config_local">Entry-specific configuration files</A></P>
	</UL>
</UL>
<H2><A NAME="overview"></A>Overview of the glidein mechanism</H2>
<P>A glidein is, simply put, a properly configured <A HREF="http://www.cs.wisc.edu/condor/manual/v7.0/3_1Introduction.html#SECTION00412000000000000000">Condor
Startd</A> submitted as a Grid job. Once a glidein starts on a worker
node, it will join a specified Condor pool, making the obtained
Grid-batch slot a slot in the Condor pool. At this point, a regular
Condor job can start there as if was a dedicated resource. <BR>See
the picture below for a schematic overview.<BR><IMG SRC="../glideins.png">Condor
glideins are a convenient way to expand a Condor pool. Apart from the
task of submitting new glideins as needed, everything else stays the
same as in a dedicated pool.</P>
<P>In glideinWMS, the <A HREF="index.html">Glidein Factory</A> is the
one that submits the glideins to the Grid resources, as shown in the
picture below.</P>
<P><IMG SRC="overview.png"><BR>This
document describes how a glidein configures and starts the <A HREF="http://www.cs.wisc.edu/condor/manual/v7.0/3_1Introduction.html#SECTION00412000000000000000">Condor
Startd</A>.</P>
<P>The glidein a factory sends is thus just a wrapper. However, it
must perform several tasks, including:</P>
<UL>
	<LI><P>check that the working environment on the worker node is
	reasonable (else user jobs will fail) 
	</P>
	<LI><P>obtain the Condor binaries 
	</P>
	<LI><P>configure Condor 
	</P>
	<LI><P>prepare the environment for Condor and the user jobs 
	</P>
	<LI><P>start Condor 
	</P>
</UL>
<P>Given the complexity of the task, and for the sake of flexibility,
it makes sense to split the script in several pieces. So the glidein
job is composed of several pieces, including a startup script, helper
scripts, the Condor binaries, and a base configuration file. 
</P>
<P>However, having a Grid job with data files can represent a
challenge; each Grid flavor treats data in a different way. To make
the system as general as possible, the glideins rely on HTTP for data
distribution. However, since the HTTP protocol is not a secure one,
the glidein implements its own security on top of it. 
</P>
<P>The picture below for an overview.<BR><IMG SRC="glidein_script.png"><BR><BR>The
security is implemented using SHA1 signatures. The signature checking
is implemented in two steps:</P>
<OL>
	<LI><P STYLE="margin-bottom: 0in">The signatures of all the files to
	be transfered are saved in a signature file and stored on the Web
	server. The signature of the signature file is then passed as one of
	the parameters of the glidein job. 
	</P>
	<LI><P>The glidein startup script loads the signature file from the
	Web server and verifies its signature. All other downloads,
	including the file containing the list of other files, is checked
	against the values in the signature file. See the pseudo-code below.</P>
	<PRE>wget http://head.fnal.gov/glidein_g1/signature.sha1
sha1sum <I>known_sha1</I> signature.sha1
if $?!=0 then
 exit 1
fi
grep files_name signature.sha1 &gt; file.sha1
wget http://head.fnal.gov/glidein_g1/files_anme
sha1sum -c file.sha1
if $?!=0 then
 exit 2
fi</PRE>
</OL>
<P>Assuming that the glidein arguments cannot be tampered with, all
the files are tamper evident.</P>
<P>If a file is marked as executable, it will be run. This allows to
customize the glidein logic at will.<BR>However, if not all files
need to be executable; plain files, like configuration files, and
tarballs are also supported.</P>
<H2><A NAME="flow"></A>Program flow</H2>
<P>The glidein startup script is tasked to setup the working
environment, configure Condor and launch the <A HREF="http://www.cs.wisc.edu/condor/manual/v7.0/3_1Introduction.html#SECTION00412000000000000000">Condor
Startd</A>.<BR>As said in the overview, a glidein is basically a
wrapper that downloads other files, executing some of them. <BR>A
private working directory is used to minimize interference with other
processes running on the same node.</P>
<P>At the high level, three types of files are handled:</P>
<UL>
	<LI><P>Signature files</P>
	<LI><P>Files containing lists of other files</P>
	<LI><P>Helper files; these can be either simple files, tarballs or
	executables.</P>
</UL>
<P>The files are also split between general, or factory wide, and
entry-specific ones. Since order can be important, especially when
executables are involved, the glidein allows for global helper files
to be loaded (and executed) before and/or after the entry-specific
ones.<BR>One executable is special; this is the helper script that
starts the <A HREF="http://www.cs.wisc.edu/condor/manual/v7.0/3_1Introduction.html#SECTION00412000000000000000">Condor
Startd</A>. This one must be the last to be run, so it is handled in
a special way.</P>
<P>See the picture below for an overview.</P>
<P><IMG SRC="flow_glidein_main.png"><BR>You
may have noticed that after the initial setup, all further
communication between stages is carried out by a locally created
config file. The reason for this is due to the fact that environment
changes can only propagate in one direction, from parent to child.
Since most of the setup is done by external executables that would be
unacceptable, so the config file was introduced</P>
<P>Some of the stages are pretty self explanatory, but most need
further details. In particular:</P>
<UL>
	<LI><P><A HREF="#flow_sign">Get signatures and file info</A></P>
	<LI><P><A HREF="#flow_file">Download and process a file</A></P>
	<LI><P><A HREF="#flow_condor">Configure and start Condor</A></P>
</UL>
<H3><A NAME="flow_sign"></A>Get signatures and file info</H3>
<P>The retrieval of the signature files is a multi step process. The
main reason being that the startup script does not know the name of
the signature file.<BR>Instead, the glidein startup script receives
the name the file that contains the names of all the other important
files. So that file is fetched first.<BR>Once the name of the
signature file is know, it is fetched and validated against the
provided SHA1 signature.<BR>Once the signature file can be trusted,
the description file is verified, too, using the signature present in
the signature file.</P>
<P>Once the signature files are fetched, the content of the
description files is loaded into memory for further processing.</P>
<P>See the figure below of an overview.</P>
<P><IMG SRC="flow_glidein_sign.png"><BR>You
have probably noticed that the name of the signature file is
extracted before validating the integrity of the description file.
This can result in a compromised signature being fetched.</P>
<P>However, this is <B>not</B> a security vulnerability. If the wrong
signature file is indeed downloaded, the signature of the signature
will not match and the glidein will terminate with a failure.</P>
<H3><A NAME="flow_file"></A>Download and process a file</H3>
<P>The glidein startup script will download and process several
files. This stage will download one of these files.</P>
<P>File downloading and processing can be conditional; if a
conditional variable name is given and such conditional variable
evaluates to False (0) in the configuration file, the stage is
effectively a NOOP.</P>
<P>The stage flow requires a fetch of a file over the network and the
validation against the proper signature file. If for some reason the
signature does not match, the glidein will terminate with a
failure.<BR>Some files need further processing; they are either
tarballs that need to be unpacked, or executables that need to be
run. This stage will take the appropriate action.</P>
<P>Finally, the invoker of this stage may request for the file
processing to be recorded in the configuration file, by providing an
output variable name. 
</P>
<P>See figure below for an overview.</P>
<P><IMG SRC="flow_glidein_file.png"></P>
<H3><A NAME="flow_condor"></A>Configure and start Condor</H3>
<P>As mentioned before, most of the work in a glidein is carried on
by the <A HREF="http://www.cs.wisc.edu/condor/manual/v7.0/3_1Introduction.html#SECTION00412000000000000000">Condor
Startd</A>. This stage the condor_startd is configured and
launched.<BR>To do this, the script parses the Condor variable
description files and extracts the needed values from the glidein
configuration file. If no values is provided, the default is used.</P>
<P>Once all the variables are collectod, the condor_config is
created.<BR>The script now launches two Condor startds, by means of a
condor_master. The first one is a monitoring startd and is not
managed.<BR>The second one is instead the main, job startd, and the
glidein code blocks on it. This startd will do the bulk of the
processing, advertising itself to a collector and accepting user
jobs.</P>
<P>Once the main startd ends, the monitoring startd is killed and the
log files parsed for job statistics that will be printed in standard
output. For debugging purposes, the whole log files are then
compressed and streamed to the standard error.</P>
<P>See figure below for an overview.</P>
<P><IMG SRC="flow_glidein_condor.png"><BR><BR><BR>
</P>
<H2><A NAME="source"></A>Source code distribution</H2>
<P>The glidein code is composed of a set of shell code scripts,
mostly using <A HREF="http://tldp.org/LDP/abs/html/">bash</A>,
although <A HREF="http://www.gnu.org/software/grep/doc/grep_13.html#SEC13">grep</A>
and <A HREF="http://www.vectorsite.net/tsawk.html">awk</A> are used
extensively, too.</P>
<P>The files are located in <BR><TT>glideinWMS/creation/web_base</TT></P>
<P>but are copied to the factory configuration directory during the
<A HREF="index.html#create_entry">factory configuration</A>.</P>
<P>The picture below shows the dependency tree of the most used
scripts. The optional scripts are grayed out.</P>
<P><IMG SRC="scripts_glidein.png"><BR CLEAR=LEFT><BR><BR>
</P>
<P>
</P>
<H2><A NAME="config">Configuration files</A></H2>
<P><BR><BR>
</P>
<TABLE WIDTH=100% BORDER=0 CELLPADDING=2 CELLSPACING=2>
	<TR VALIGN=TOP>
		<TD>
			<H2 ALIGN=LEFT>Repository</H2>
			<H3 ALIGN=LEFT>CVSROOT</H3>
			<P ALIGN=LEFT>cvsuser@cdcvs.fnal.gov:/cvs/cd</P>
			<H2 ALIGN=LEFT>Package(s)</H2>
			<P ALIGN=LEFT>glideinWMS/creation</P>
		</TD>
		<TD>
			<H2 ALIGN=LEFT>Author(s)</H2>
			<P ALIGN=LEFT>Since Aug. 14th 2006 - Igor Sfiligoi (Fermilab
			Computing Division)</P>
		</TD>
	</TR>
</TABLE>
<P><BR><BR>
</P>
</BODY>
</HTML>
