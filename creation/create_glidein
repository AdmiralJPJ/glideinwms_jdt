#!/bin/env python

import os
import copy
import sys
import os.path
import string
import shutil
import traceback
sys.path.append("lib")
import cgWParams
import cgWDictFile
import cgWConsts
import cgWCreate
import cgWParamDict


################################################################################

def main(params):
    #print params.__dict__
    glidein_dicts_obj=cgWParamDict.glideinDicts(params)
    glidein_dicts_obj.populate()

    glidein_dicts_obj.create_dirs()
    try:
        # save files in dictionaries
        glidein_dicts_obj.save()
        glidein_dicts_obj.set_readonly(True)

        # copy the submit files
        copy_submit_exe(cgWConsts.STARTUP_FILE,glidein_dicts_obj.main_dicts.submit_dir,params.src_dir)
        copy_submit_exe(cgWConsts.SUBMIT_WRAPPER,glidein_dicts_obj.main_dicts.submit_dir,params.src_dir)
        copy_submit_exe(cgWConsts.LOCAL_START_WRAPPER,glidein_dicts_obj.main_dicts.submit_dir,params.src_dir)

        # save config into file
        cfgfile=os.path.join(glidein_dicts_obj.main_dicts.submit_dir,cgWConsts.XML_CONFIG_FILE)
        params.save_into_file(cfgfile)
        # make two copies, the second one should have a unique name, so it does not get overwritten on reconfig
        cfgfile=cgWConsts.insert_timestr(cfgfile)
        params.save_into_file(cfgfile)
    except:
        glidein_dicts_obj.delete_dirs()
        raise

    print "Created glidein '%s'"%params.glidein_name
    print "Submit files can be found in %s"%glidein_dicts_obj.main_dicts.submit_dir
    print "Support files are in %s"%glidein_dicts_obj.main_dicts.stage_dir
    print "Monitoring files are in %s"%glidein_dicts_obj.main_dicts.monitor_dir


############################################################
#
# P R I V A T E - Do not use
# 
############################################################


#####################
# Simply copy a file
def copy_file(infile,outfile):
    try:
        shutil.copy2(infile,outfile)
    except IOError, e:
        raise RuntimeError, "Error copying %s in %s: %s"%(infile,outfile,e)
        
#####################
# Copy a regular file
def copy_submit_exe(filename,submit_dir,org_dir):
    copy_file(os.path.join(org_dir,filename),submit_dir)
    os.chmod(os.path.join(submit_dir,filename),0544)
    
############################################################
#
# S T A R T U P
# 
############################################################

if __name__ == '__main__':
    try:
        params=cgWParams.Params(sys.argv)
    except RuntimeError,e:
        print e
        sys.exit(1)
    try:
        main(params)
    except RuntimeError, e:
        print params.usage()
        print ""
        print e

###########################################################
#
# CVS info
#
# $Id: create_glidein,v 1.126 2008/03/28 17:13:43 sfiligoi Exp $
#
# Log:
#  $Log: create_glidein,v $
#  Revision 1.126  2008/03/28 17:13:43  sfiligoi
#  Save the cfg file with a timestamp, too
#
#  Revision 1.125  2007/12/17 18:53:45  sfiligoi
#  Fix typo
#
#  Revision 1.124  2007/12/17 18:44:47  sfiligoi
#  Add local start wrapper
#
#  Revision 1.123  2007/12/14 16:28:53  sfiligoi
#  Move directory creation into the Dict classes
#
#  Revision 1.121  2007/12/13 23:26:20  sfiligoi
#  Get attributes out of stage and only into submit
#
#  Revision 1.119  2007/12/13 20:19:45  sfiligoi
#  Move condor jdl into entry subdir, and implement it via a dictionary
#
#  Revision 1.118  2007/12/12 00:35:36  sfiligoi
#  Move creation of glidein and job_descript files from cgWCreate to cgWParamDict
#
#  Revision 1.117  2007/12/11 23:57:11  sfiligoi
#  Get directories always from glidein_dicts_obj
#
#  Revision 1.116  2007/12/11 23:52:40  sfiligoi
#  Create monitor_dir in a single place
#
#  Revision 1.115  2007/12/11 23:47:52  sfiligoi
#  Rename entry_dirs to have local scope
#
#  Revision 1.114  2007/12/11 23:31:46  sfiligoi
#  Create entry_dirs in a single place
#
#  Revision 1.113  2007/12/11 23:26:25  sfiligoi
#  Consistently use entry_dirs
#
#  Revision 1.111  2007/12/11 23:09:54  sfiligoi
#  Move the population of dictionaries into cgWParamDict
#
#  Revision 1.74  2007/05/18 19:07:18  sfiligoi
#  Add CVS tags
#
#
###########################################################
