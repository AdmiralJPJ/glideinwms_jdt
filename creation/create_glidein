#!/bin/env python

#
# Description:
#  This program creates a glidein factory directory structure
#  based on a configuration file
#

import os
import copy
import sys
STARTUP_DIR=sys.path[0]
import os.path
import string
import shutil
import traceback
sys.path.append(os.path.join(STARTUP_DIR,"lib"))
sys.path.append(os.path.join(STARTUP_DIR,"../lib"))
import cgWParams
import cgWDictFile
import cgWConsts
import cgWCreate
import cgWParamDict


################################################################################

def main(params):
    #print params.__dict__
    glidein_dicts_obj=cgWParamDict.glideinDicts(params)
    glidein_dicts_obj.populate()

    glidein_dicts_obj.create_dirs()
    try:
        # save files in dictionaries
        glidein_dicts_obj.save()
        glidein_dicts_obj.set_readonly(True)

        # copy the submit files
        copy_submit_exe(cgWConsts.STARTUP_FILE,glidein_dicts_obj.main_dicts.submit_dir,params.src_dir)
        copy_submit_exe(cgWConsts.SUBMIT_WRAPPER,glidein_dicts_obj.main_dicts.submit_dir,params.src_dir)
        copy_submit_exe(cgWConsts.LOCAL_START_WRAPPER,glidein_dicts_obj.main_dicts.submit_dir,params.src_dir)

        # save config into file
        cfgfile=os.path.join(glidein_dicts_obj.main_dicts.submit_dir,cgWConsts.XML_CONFIG_FILE)
        params.save_into_file(cfgfile)
        # make two copies, the second one should have a unique name, so it does not get overwritten on reconfig
        cfgfile=cgWConsts.insert_timestr(cfgfile)
        params.save_into_file(cfgfile)

        # create the init.d starup file
        cgWCreate.create_initd_startup(os.path.join(glidein_dicts_obj.main_dicts.submit_dir,cgWConsts.INITD_STARTUP_FILE),
                                       glidein_dicts_obj.main_dicts.submit_dir,
                                       os.path.realpath(os.path.join(STARTUP_DIR,'..')))
    except:
        glidein_dicts_obj.delete_dirs()
        raise

    print "Created glidein '%s'"%params.glidein_name
    print "Active entries are:"
    for entry in glidein_dicts_obj.active_entry_list:
        print "  %s"%entry
    print "Submit files can be found in %s"%glidein_dicts_obj.main_dicts.submit_dir
    print "Support files are in %s"%glidein_dicts_obj.main_dicts.stage_dir
    print "Monitoring files are in %s"%glidein_dicts_obj.main_dicts.monitor_dir


############################################################
#
# P R I V A T E - Do not use
# 
############################################################


#####################
# Simply copy a file
def copy_file(infile,outfile):
    try:
        shutil.copy2(infile,outfile)
    except IOError, e:
        raise RuntimeError, "Error copying %s in %s: %s"%(infile,outfile,e)
        
#####################
# Copy a regular file
def copy_submit_exe(filename,submit_dir,org_dir):
    copy_file(os.path.join(org_dir,filename),submit_dir)
    os.chmod(os.path.join(submit_dir,filename),0544)
    
############################################################
#
# S T A R T U P
# 
############################################################

if __name__ == '__main__':
    usage_prefix="create_glidein [-writeback yes|no]"
    argv=sys.argv
    writeback='yes'
    while len(argv)>2:
        if argv[1]=='-writeback':
            writeback=argv[2]
            argv=argv[0:1]+argv[3:]
        else:
            break
            
    try:
        params=cgWParams.Params(usage_prefix,os.path.join(STARTUP_DIR,"web_base"),argv)
    except RuntimeError,e:
        print e
        sys.exit(1)
        
    if not (writeback in ('yes','no')):
        print params.usage()
        print ""
        print "-writeback must be yes or no, found '%s'"%writeback
        sys.exit(1)
        
    try:
        main(params)
    except RuntimeError, e:
        print params.usage()
        print ""
        print e
        sys.exit(1)

    try:
        if writeback=='yes':
            params.save_into_file_wbackup(params.cfg_name)
    except:
        print "Writing back config file failed"
        sys.exit(1)

###########################################################
#
# CVS info
#
# $Id: create_glidein,v 1.138 2008/07/23 16:40:59 sfiligoi Exp $
#
# Log:
#  $Log: create_glidein,v $
#  Revision 1.138  2008/07/23 16:40:59  sfiligoi
#  Add missing exits in case of error
#
#  Revision 1.137  2008/07/21 15:51:28  sfiligoi
#  Fix typo
#
#  Revision 1.136  2008/07/21 15:42:42  sfiligoi
#  Add support for rewriting the config file
#
#  Revision 1.133  2008/07/15 21:25:58  sfiligoi
#  Use -force_name
#
#  Revision 1.132  2008/07/15 20:49:46  sfiligoi
#  Improve usage printout
#
#  Revision 1.131  2008/07/11 15:49:10  sfiligoi
#  Printout active entries during creation and reconfig
#
#  Revision 1.130  2008/07/10 19:21:16  sfiligoi
#  Make it executable from any disk location
#
#  Revision 1.129  2008/07/10 18:57:47  sfiligoi
#  Move all path changes out of the libraries
#
#  Revision 1.128  2008/07/08 20:49:07  sfiligoi
#  Add init.d startup file
#
#  Revision 1.127  2008/07/07 20:30:05  sfiligoi
#  Add comments
#
#  Revision 1.126  2008/03/28 17:13:43  sfiligoi
#  Save the cfg file with a timestamp, too
#
#  Revision 1.125  2007/12/17 18:53:45  sfiligoi
#  Fix typo
#
#  Revision 1.124  2007/12/17 18:44:47  sfiligoi
#  Add local start wrapper
#
#  Revision 1.123  2007/12/14 16:28:53  sfiligoi
#  Move directory creation into the Dict classes
#
#  Revision 1.121  2007/12/13 23:26:20  sfiligoi
#  Get attributes out of stage and only into submit
#
#  Revision 1.119  2007/12/13 20:19:45  sfiligoi
#  Move condor jdl into entry subdir, and implement it via a dictionary
#
#  Revision 1.118  2007/12/12 00:35:36  sfiligoi
#  Move creation of glidein and job_descript files from cgWCreate to cgWParamDict
#
#  Revision 1.117  2007/12/11 23:57:11  sfiligoi
#  Get directories always from glidein_dicts_obj
#
#  Revision 1.116  2007/12/11 23:52:40  sfiligoi
#  Create monitor_dir in a single place
#
#  Revision 1.115  2007/12/11 23:47:52  sfiligoi
#  Rename entry_dirs to have local scope
#
#  Revision 1.114  2007/12/11 23:31:46  sfiligoi
#  Create entry_dirs in a single place
#
#  Revision 1.113  2007/12/11 23:26:25  sfiligoi
#  Consistently use entry_dirs
#
#  Revision 1.111  2007/12/11 23:09:54  sfiligoi
#  Move the population of dictionaries into cgWParamDict
#
#  Revision 1.74  2007/05/18 19:07:18  sfiligoi
#  Add CVS tags
#
#
###########################################################
